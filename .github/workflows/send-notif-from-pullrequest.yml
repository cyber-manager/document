name: Telegram Notifications

on:
  # Trigger when a PR is opened (works for forks using pull_request_target)
  pull_request_target:
    types:
      - opened

jobs:
  # PR notification job - runs when PR is opened
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification on PR
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping PR notification."
            exit 0
          fi
          
          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO="\nüì¢ *Channel:* $TELEGRAM_CHANNEL_LINK"
          fi
          
          # Build PR notification message
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          MESSAGE="üìù *New Pull Request*\\n\\nüì¶ *Repository:* \`${{ github.repository }}\`\\nüî¢ *PR Number:* #${{ github.event.pull_request.number }}\\nüìã *Title:* ${PR_TITLE}\\nüë§ *Author:* ${{ github.event.pull_request.user.login }}\\nüåø *Branch:* \`${{ github.event.pull_request.head.ref }}\` ‚Üí \`${{ github.event.pull_request.base.ref }}\`\\nüìù *Description:*\\n${PR_BODY}${CHANNEL_INFO}\\n\\nüîó *View PR:* ${{ github.event.pull_request.html_url }}"
          
          # Send message to Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true
          
          echo "üì± Telegram PR notification sent"
