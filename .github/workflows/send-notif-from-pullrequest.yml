name: Telegram Notifications

on:
  # Trigger when a PR is opened (works for forks using pull_request_target)
  pull_request_target:
    types:
      - opened

jobs:
  # PR notification job - runs when PR is opened
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification on PR
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping PR notification."
            exit 0
          fi
          
          # Get PR details
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          # Escape special characters for Markdown (escape backslash first, then other chars)
          PR_TITLE_ESC=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g' | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g')
          PR_BODY_ESC=$(echo "$PR_BODY" | sed 's/\\/\\\\/g' | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g' | head -c 1000)
          
          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO=$'\n'"üì¢ *Channel:* $TELEGRAM_CHANNEL_LINK"
          fi
          
          # Build message with proper newlines
          MESSAGE="üìù *New Pull Request*"$'\n\n'"üì¶ *Repository:* \`${REPO}\`"$'\n'"üî¢ *PR Number:* #${PR_NUMBER}"$'\n'"üìã *Title:* ${PR_TITLE_ESC}"$'\n'"üë§ *Author:* ${AUTHOR}"$'\n'"üåø *Branch:* \`${HEAD_REF}\` ‚Üí \`${BASE_REF}\`"$'\n'"üìù *Description:*"$'\n'"${PR_BODY_ESC}${CHANNEL_INFO}"$'\n\n'"üîó *View PR:* ${PR_URL}"
          
          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Telegram PR notification sent successfully"
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
