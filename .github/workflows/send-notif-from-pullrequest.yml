name: Telegram Notifications

on:
  # Trigger when a PR is opened (works for forks using pull_request_target)
  pull_request_target:
    types:
      - opened

jobs:
  # PR notification job - runs when PR is opened
  notify-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification on PR
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHANNEL_LINK: ${{ secrets.TELEGRAM_CHANNEL_LINK }}
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping PR notification."
            exit 0
          fi
          
          # Get PR details
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          # Escape HTML special characters
          PR_TITLE_ESC=$(echo "$PR_TITLE" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          PR_BODY_ESC=$(echo "$PR_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g' | head -c 1000)
          
          # Add channel link if provided
          CHANNEL_INFO=""
          if [ -n "$TELEGRAM_CHANNEL_LINK" ]; then
            CHANNEL_INFO=$'\n'"üì¢ <b>Channel:</b> $TELEGRAM_CHANNEL_LINK"
          fi
          
          # Build message with HTML formatting
          MESSAGE="üìù <b>New Pull Request</b>"$'\n\n'"üì¶ <b>Repository:</b> <code>${REPO}</code>"$'\n'"üî¢ <b>PR Number:</b> #${PR_NUMBER}"$'\n'"üìã <b>Title:</b> ${PR_TITLE_ESC}"$'\n'"üë§ <b>Author:</b> ${AUTHOR}"$'\n'"üåø <b>Branch:</b> <code>${HEAD_REF}</code> ‚Üí <code>${BASE_REF}</code>"$'\n'"üìù <b>Description:</b>"$'\n'"${PR_BODY_ESC}${CHANNEL_INFO}"$'\n\n'"üîó <a href=\"${PR_URL}\">View PR</a>"
          
          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Telegram PR notification sent successfully"
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
